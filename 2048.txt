#include <graphics.h>
#include <conio.h>
#include <stdio.h>
#include<time.h>
#include<stdio.h>
#pragma comment(lib,"Winmm.lib")


void background();
void background1();
void background2();
void background3();
void start();
void movemusic();
int ini();
void end();
void control(int []);
int score=0;//记录分数
int q=0;//判断游戏是否结束


void main()
{
	int cnt=0;
	char num1[100],num2[100];
	int s[16]={0};
	int x,y;//记录初始2个方块的位置
	initgraph(640,480);
	srand( (unsigned)time(NULL));//
	mciSendString("open 1.mp3 alias mymusic", NULL, 0, NULL);
	mciSendString("play mymusic", NULL, 0, NULL);//播放音乐
	background();
	background1(); //开始界面 
	start();
	
	x=ini();
	y=ini();
	while (x==y)
		x=ini();

	s[x]=s[y]=2;
	setfont(60,0,"华文行楷");
	settextcolor(RGB(244,164,96));
	sprintf(num1,"%d",s[x]);
	sprintf(num2,"%d",s[y]);
	outtextxy(80+(x%4)*100,80+(x/4)*100,num1);
	outtextxy(80+(y%4)*100,80+(y/4)*100,num2);//初始化2个随机方块为2

	
	do
	{
	cnt=0;
	control(s);
	for (int i=0;i<16;i++)
	{
		if (s[i]!=0)
			cnt++;
	}
	if (cnt==16)
	{q++;
	 end();
	}
	}while(q==0);//移动操作

}


void movemusic()
{
    mciSendString("stop music", NULL, 0, NULL);
	mciSendString("close music", NULL, 0, NULL);
	mciSendString("open 3.wav alias music", NULL, 0, NULL);
	mciSendString("play music", NULL, 0, NULL);//播放音乐

}


void start()
{
	MOUSEMSG m;
	while (true)
	{
		float H=255;
		float S=99;
		float L=71;
		m=GetMouseMsg();
		if (m.x>240 && m.x<400 && m.y>300&&m.y<340)
		{
			settextcolor(RGB(H, S, L));
			setfont(40,0,"华文行楷"); 
		    outtextxy(240,300, "开始游戏");
			if (m.uMsg==WM_LBUTTONDOWN)
			{
			mciSendString("stop mymusic", NULL, 0, NULL);
	        mciSendString("close mymusic", NULL, 0, NULL);//关闭背景音乐
			background2();
			break;}
		}
		else
		{
			settextcolor(WHITE);
			setfont(40,0,"华文行楷"); 
		    outtextxy(240,300, "开始游戏");
		}
		if (m.x>240 && m.x<400 && m.y>350&&m.y<390)
		{
			settextcolor(RGB(H, S, L));
			setfont(40,0,"华文行楷"); 
		    outtextxy(240,350, "操作说明");
			if (m.uMsg==WM_LBUTTONDOWN)
			{background3();
			Sleep(3000);
			mciSendString("stop mymusic", NULL, 0, NULL);
	        mciSendString("close mymusic", NULL, 0, NULL);//关闭背景音乐
			background2();
			break;
			}
		}
		else
		{
			settextcolor(WHITE);
			setfont(40,0,"华文行楷"); 
		    outtextxy(240,350, "操作说明");
		}
		if (m.x>240 && m.x<400 && m.y>400&&m.y<440)
		{
			settextcolor(RGB(H, S, L));
			setfont(40,0,"华文行楷"); 
		    outtextxy(240,400, "退出游戏");
			if (m.uMsg==WM_LBUTTONDOWN)
			{closegraph();
			break;}
		}
		else
		{
			settextcolor(WHITE);
			setfont(40,0,"华文行楷"); 
		    outtextxy(240,400, "退出游戏");
		}
	}
}


void background()
{
loadimage(NULL, "C:\\yxdown\\2048\\8.jpg",640,480);
Sleep(4000);
}


void background1()
{

    loadimage(NULL, "C:\\yxdown\\2048\\1.jpg",640,480);
	setbkmode(TRANSPARENT);	
	setfont(40,0,"华文行楷"); 
	outtextxy(380,440, "Made by MY");

}


void background2()
{

	loadimage(NULL, "C:\\yxdown\\2048\\3.jpg",640,480);
	setlinecolor(RGB(169,169,169));	
	setlinestyle(PS_SOLID | PS_JOIN_BEVEL, 10);
	for(int i=0;i<=4;i++)
	{line(50+100*i,50,50+100*i,450);}
	for(int j=0;j<=4;j++)
	{line(50,50+100*j,450,50+100*j);}
	settextcolor(RGB(244,164,96));
	setfont(40,0,"华文行楷");
	outtextxy(450,150, "q:结束游戏");
	outtextxy(450,100,"分数:");
}


void background3()
{
	cleardevice();
	setbkcolor(RGB(192,192,192));
	cleardevice();
    settextcolor(RGB(255,160,122));
	outtextxy(240,100, "w:上移");
	outtextxy(240,150, "s:下移");
	outtextxy(240,200, "a:左移");
	outtextxy(240,250, "d:右移");
	outtextxy(240,300, "q:退出游戏");
	outtextxy(240,350, "2s后自动进入游戏");

}


int ini()
{
	int a;
	srand( (unsigned)time(NULL));
	a=rand()%16;
	return a;
}//初始化位置


void control(int *s)
{
	int p[16]={0};
	int y=0;
	int  i,j,x;
	char out3[16][100];
	int t;
	char c;
	int num[4][4];
	for (i=0;i<4;++i)
	{
		for (j=0;j<4;j++)
		{
			num[i][j]=s[4*i+j];
		}
	}
	setfont(50,0,"华文行楷");
	char sco[100];
	sprintf(sco,"%d",score);
	outtextxy(550,100,sco);
	score+=10;
	c=getch();
	movemusic();
    switch(c)
	{
	case 'a':
		for (i=0;i<4;i++)
		{
		 for(x=0;x<3;x++)
		 {
		 for(j=2;j>=0;j--)
		 {
			if (num[i][j]==0)
			{
			t=num[i][j+1];
			num[i][j+1]=num[i][j];
			num[i][j]=t;
			}
		 }
		 }
		}
		for(i=0;i<4;i++)
		{
						for(j=0;j<3;j++)
							if(num[i][j]==num[i][j+1])
							{
								if(num[i][j]!=0)
									score+=12;
								num[i][j]=num[i][j+1]+num[i][j];
								num[i][j+1]=0;						
							}
		}
		for (i=0;i<4;i++)
		{
		for(x=0;x<3;x++)
		{
		for(j=2;j>=0;j--)
		{
			if (num[i][j]==0)
			{
			t=num[i][j+1];
			num[i][j+1]=num[i][j];
			num[i][j]=t;
			}
		}
		}
		}
		for (i=0;i<4;++i)
		{
		for (j=0;j<4;j++)
		{
			s[4*i+j]=num[i][j];
		}
		}
		background2();
		for(i=0;i<16;i++)
			{
				if(s[i]!=0)
				{        
					    setfont(50,0,"华文行楷");
						sprintf(out3[i],"%d",s[i]);
						outtextxy(80+(i%4)*100,80+(i/4)*100,out3[i]);	 
				}
			}
		for(i=0;i<16;i++)
		{
			if (s[i]==0)
				p[y++]=i;	
		}
		x=rand()%y;
		j=p[x];
		s[j]=2;
	    setfont(50,0,"华文行楷");
		sprintf(out3[j],"%d",s[j]);
		outtextxy(80+(j%4)*100,80+(j/4)*100,out3[j]);
		break;

    case 'd':
	    for (i=0;i<4;i++)
		{
		for(x=0;x<3;x++)
		{
		for(j=1;j<=3;j++)
		{
			if (num[i][j]==0)
			{
			t=num[i][j-1];
			num[i][j-1]=num[i][j];
			num[i][j]=t;
			}
		}
		}
		}
		for(i=0;i<4;i++)
		{
						for(j=0;j<3;j++)
							if(num[i][j]==num[i][j+1])
							{
								num[i][j]=num[i][j+1]+num[i][j];
								num[i][j+1]=0;
								if(num[i][j]!=0)
									score+=12;
							}
		}
		for (i=0;i<4;i++)
		{
		for(x=0;x<3;x++)
		{
		for(j=1;j<=3;j++)
		{
			if (num[i][j]==0)
			{
			t=num[i][j-1];
			num[i][j-1]=num[i][j];
			num[i][j]=t;
			}
		}
		}
		}
		for (i=0;i<4;++i)
		{
		for (j=0;j<4;j++)
		{
			s[4*i+j]=num[i][j];
		}
		}
		background2();
		for(i=0;i<16;i++)
			{
				if(s[i]!=0)
				{
						setfont(50,0,"华文行楷");
						sprintf(out3[i],"%d",s[i]);
						outtextxy(80+(i%4)*100,80+(i/4)*100,out3[i]);	 
				}
			}
		for(i=0;i<16;i++)
		{
			if (s[i]==0)
				p[y++]=i;	
		}
		x=rand()%y;
		j=p[x];
		s[j]=2;
		setfont(50,0,"华文行楷");
		sprintf(out3[j],"%d",s[j]);
		outtextxy(80+(j%4)*100,80+(j/4)*100,out3[j]);
		break;
	
	case 'w':
		for (j=0;j<=3;j++)
		{
		for(x=0;x<3;x++)
		{
		for(i=0;i<3;i++)
		{
			if (num[i][j]==0)
			{
			t=num[i+1][j];
			num[i+1][j]=num[i][j];
			num[i][j]=t;
			}
		}
		}
		}
		for(j=0;j<4;j++)
		{
						for(i=0;i<4;i++)
							if(num[i][j]==num[i+1][j])
							{
								num[i][j]=num[i+1][j]+num[i][j];
								num[i+1][j]=0;
								if(num[i][j]!=0)
									score+=12;
							}
		}
	    for (j=0;j<4;j++)
		{
		for(x=0;x<3;x++)
		{
		for(i=0;i<3;i++)
		{
			if (num[i][j]==0)
			{
			t=num[i+1][j];
			num[i+1][j]=num[i][j];
			num[i][j]=t;
			}
		}
		}
		}
		for (i=0;i<4;++i)
		{
		for (j=0;j<4;j++)
		{
			s[4*i+j]=num[i][j];
		}
		}
		background2();
		for(i=0;i<16;i++)
			{
				if(s[i]!=0)
				{
						setfont(50,0,"华文行楷");
						sprintf(out3[i],"%d",s[i]);
						outtextxy(80+(i%4)*100,80+(i/4)*100,out3[i]);	 
				}
			}
		for(i=0;i<16;i++)
		{
			if (s[i]==0)
				p[y++]=i;	
		}
		x=rand()%y;
		j=p[x];
		s[j]=2;
		setfont(50,0,"华文行楷");
		sprintf(out3[j],"%d",s[j]);
		outtextxy(80+(j%4)*100,80+(j/4)*100,out3[j]);
		break;
	
	case 's':
		for (j=0;j<4;j++)
		{
		for(x=0;x<3;x++)
		{
		for(i=1;i<=3;i++)
		{
			if (num[i][j]==0)
			{
			t=num[i-1][j];
			num[i-1][j]=num[i][j];
			num[i][j]=t;
			}
		}
		}
		}
		for(j=0;j<4;j++)
		{
						for(i=0;i<4;i++)
							if(num[i][j]==num[i+1][j])
							{
								num[i][j]=num[i+1][j]+num[i][j];
								num[i+1][j]=0;
								if(num[i][j]!=0)
									score+=12;
							}
		}
        for (j=0;j<4;j++)
		{
		for(x=0;x<3;x++)
		{
		for(i=1;i<=3;i++)
		{
			if (num[i][j]==0)
			{
			t=num[i-1][j];
			num[i-1][j]=num[i][j];
			num[i][j]=t;
			}
		}
		}
		}
		for (i=0;i<4;++i)
		{
		for (j=0;j<4;j++)
		{
			s[4*i+j]=num[i][j];
		}
		}
		background2();
		for(i=0;i<16;i++)
			{
				if(s[i]!=0)
				{
						setfont(50,0,"华文行楷");
						sprintf(out3[i],"%d",s[i]);
						outtextxy(80+(i%4)*100,80+(i/4)*100,out3[i]);	 
				}
			}
		for(i=0;i<16;i++)
		{
			if (s[i]==0)
				p[y++]=i;	
		}
		x=rand()%y;
		j=p[x];
		s[j]=2;
        setfont(50,0,"华文行楷"); 	
		sprintf(out3[j],"%d",s[j]);
		outtextxy(80+(j%4)*100,80+(j/4)*100,out3[j]);
		break;

	case 'q':
		q++;
		end();
		break;

	default:
		break;
	}

	
}


void end()
{
    cleardevice();
	setbkcolor(RGB(255,160,122));
	cleardevice();
    settextcolor(RGB(192,192,192));
	outtextxy(180,160,"Your score:");
	char sco[100];
	sprintf(sco,"%d",score-10);
	outtextxy(400,160,sco);
	outtextxy(360,300,"Thanks");
	Sleep(4000);
}//结束界面